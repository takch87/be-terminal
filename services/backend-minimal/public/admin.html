<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Be Seamless - Panel de Administraci√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Navigation */
        .nav-container {
            background: white;
            border-bottom: 1px solid #eee;
            padding: 0 2rem;
        }

        .nav {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 2rem;
        }

        .nav-item {
            padding: 1rem 0;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-item:hover,
        .nav-item.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section.hidden {
            display: none;
        }

        .section-header {
            background: #f8f9fa;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
        }

        .section-content {
            padding: 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .stat-card.error {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .stat-card.pending {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Buttons */
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin-right: 0.5rem;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #48bb78;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-warning {
            background: #ed8936;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-danger, .badge-error {
            background: #fed7d7;
            color: #c53030;
        }

        .badge-warning {
            background: #fefcbf;
            color: #b7791f;
        }

        .badge-info {
            background: #bee3f8;
            color: #2a69ac;
        }

        .badge-pending {
            background: #e2e8f0;
            color: #4a5568;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        /* Error/Success Messages */
        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #276749;
        }

        .alert-error {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
        }

        .alert-info {
            background: #ebf8ff;
            border: 1px solid #90cdf4;
            color: #2a69ac;
        }

        /* Downloads Section */
        .downloads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .download-card {
            background: white;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
            display: grid;
            grid-template-columns: 60px 1fr; /* icon | text */
            grid-auto-rows: auto;
            align-items: center;
            gap: 1rem;
            overflow: hidden;
        }

        .download-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .download-icon {
            font-size: 3rem;
            min-width: 60px;
            text-align: center;
        }

        .download-info {
            min-width: 0; /* allow text to shrink */
        }

        .download-info h3 {
            margin: 0 0 0.5rem 0;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .download-info p {
            margin: 0 0 0.25rem 0;
            color: #667eea;
            font-weight: 600;
        }

        .download-info small {
            color: #718096;
            font-size: 0.85rem;
        }

        .download-actions {
            grid-column: 1 / -1; /* full width under text */
            min-width: 0;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: .5rem;
        }

        .downloads-info {
            margin-bottom: 1rem;
        }

        .downloads-info code {
            background: #f7fafc;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        /* Responsive */
    @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .nav {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .main-container {
                padding: 0 1rem;
            }

            .section-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            /* Downloads: stack on mobile */
            .downloads-grid { grid-template-columns: 1fr; }
            .download-card { grid-template-columns: 60px 1fr; }
            .download-actions { grid-column: 1 / -1; width: 100%; min-width: 0; margin-top: .75rem; justify-content: stretch; }
            .download-actions .btn { width: 100%; display: inline-flex; justify-content: center; }
            .download-icon { font-size: 2.2rem; }
            .download-info h3 { font-size: 1rem; }
            .download-info p { font-size: .95rem; }
        }

        /* Medium screens: wrap actions below to avoid overlap */
        @media (max-width: 1200px) {
            .download-card { grid-template-columns: 60px 1fr; align-items: flex-start; }
            .download-actions { grid-column: 1 / -1; width: 100%; justify-content: flex-start; margin-top: .75rem; }
            .download-actions .btn { width: 100%; }
        }

        /* Ensure long button labels don‚Äôt overflow */
        .download-actions .btn { white-space: nowrap; max-width: 100%; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">‚ö° Be Seamless Admin</div>
            <div class="user-info">
                <span id="username">Admin</span>
                <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-container">
        <div class="nav">
            <div class="nav-item active" onclick="showSection('dashboard')">üìä Dashboard</div>
            <div class="nav-item" onclick="showSection('users')">üë• Usuarios</div>
            <div class="nav-item" onclick="showSection('events')">üé´ Eventos</div>
            <div class="nav-item" onclick="showSection('transactions')">üí≥ Transacciones</div>
            <div class="nav-item" onclick="showSection('downloads')">üì± Descargas</div>
            <div class="nav-item" onclick="showSection('payments')">‚öôÔ∏è Payment Config</div>
            <div class="nav-item" onclick="showSection('system')">üîß Sistema</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section">
            <div class="section-header">
                <div class="section-title">üìä Dashboard Principal</div>
                <button class="btn" onclick="refreshDashboard()">üîÑ Actualizar</button>
            </div>
            <div class="section-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-users">-</div>
                        <div class="stat-label">Total Usuarios</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-events">-</div>
                        <div class="stat-label">Eventos Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-transactions">-</div>
                        <div class="stat-label">Total Transacciones</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-revenue">-</div>
                        <div class="stat-label">Ingresos ($)</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card success">
                        <div class="stat-number" id="successful-transactions">-</div>
                        <div class="stat-label">‚úÖ Exitosas</div>
                    </div>
                    <div class="stat-card error">
                        <div class="stat-number" id="failed-transactions">-</div>
                        <div class="stat-label">‚ùå Fallidas</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number" id="canceled-transactions">-</div>
                        <div class="stat-label">üö´ Canceladas</div>
                    </div>
                    <div class="stat-card pending">
                        <div class="stat-number" id="pending-transactions">-</div>
                        <div class="stat-label">‚è≥ Pendientes</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card info">
                        <div class="stat-number" id="success-rate">-</div>
                        <div class="stat-label">üìä Tasa de √âxito</div>
                    </div>
                </div>

                <div class="section-header">
                    <div class="section-title">üìà Actividad Reciente</div>
                </div>
                <div id="recent-activity">
                    <div class="loading">Cargando actividad reciente...</div>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users-section" class="section hidden">
            <div class="section-header">
                <div class="section-title">üë• Gesti√≥n de Usuarios</div>
                <button class="btn btn-success" onclick="showCreateUser()">+ Nuevo Usuario</button>
            </div>
            <div class="section-content">
                <div id="users-content">
                    <div class="loading">Cargando usuarios...</div>
                </div>
            </div>
        </div>

        <!-- Events Section -->
        <div id="events-section" class="section hidden">
            <div class="section-header">
                <div class="section-title">üé´ Gesti√≥n de Eventos</div>
                <button class="btn btn-success" onclick="showCreateEvent()">+ Nuevo Evento</button>
            </div>
            <div class="section-content">
                <div id="events-content">
                    <div class="loading">Cargando eventos...</div>
                </div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div id="transactions-section" class="section hidden">
            <div class="section-header">
                <div class="section-title">üí≥ Historial de Transacciones</div>
                <button class="btn" onclick="refreshTransactions()">üîÑ Actualizar</button>
            </div>
            <div class="section-content">
                <div id="transactions-content">
                    <div class="loading">Cargando transacciones...</div>
                </div>
            </div>
        </div>

        <!-- Downloads Section -->
        <div id="downloads-section" class="section hidden">
            <div class="section-header">
                <div class="section-title">üì± Descargas de la App</div>
                <button class="btn" onclick="refreshDownloads()">üîÑ Actualizar</button>
            </div>
            <div class="section-content">
                <div class="downloads-info">
                    <div class="alert alert-info">
                        <strong>üì± Aplicaci√≥n M√≥vil Be Seamless</strong><br>
                        Descarga la √∫ltima versi√≥n de la aplicaci√≥n m√≥vil para Android.
                        <br><br>
                        <strong>Credenciales de prueba:</strong><br>
                        ‚Ä¢ Usuario: <code>demo</code> / Contrase√±a: <code>demo123</code><br>
                        ‚Ä¢ Usuario: <code>admin</code> / Contrase√±a: <code>admin123</code>
                    </div>
                </div>
                
                <div style="margin-bottom:0.75rem;font-size:0.85rem;color:#555">Los APK deben llevar versi√≥n en el nombre: ejemplo <code>android-terminal-v0.2.0-release.apk</code>. El sistema detecta patr√≥n <code>-vX.Y.Z-</code> o <code>_vX.Y.Z</code>.</div>
                <div id="downloads-dynamic" class="downloads-grid"></div>

                <div style="margin-top: 2rem;">
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Instalaci√≥n en Android:</strong><br>
                        1. Descarga el archivo APK<br>
                        2. Habilita "Fuentes desconocidas" en Configuraci√≥n > Seguridad<br>
                        3. Abre el archivo APK descargado para instalar<br>
                        4. Acepta los permisos necesarios
                    </div>
                </div>
            </div>
        </div>

    <!-- Payment Config Section -->
        <div id="payments-section" class="section hidden">
            <div class="section-header">
                <div class="section-title">‚öôÔ∏è Configuraci√≥n de Procesadores de Pago</div>
            </div>
            <div class="section-content">
                <!-- Local styles for tabs -->
                <style>
                    .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 1rem; gap: .5rem; }
                    .tab { padding: .5rem 1rem; cursor: pointer; border-bottom: 3px solid transparent; border-radius: .25rem .25rem 0 0; color: #4a5568; font-weight: 600; }
                    .tab.active { color: #4f46e5; border-bottom-color: #4f46e5; background: #f8fafc; }
                    .tab-content { display: none; }
                    .tab-content.active { display: block; }
                    .proc-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
                    .badge { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: .8rem; }
                    .badge-success { background: #d1fae5; color: #065f46; }
                    .badge-danger { background: #fee2e2; color: #991b1b; }
                    .field-hint { display:block; color:#718096; margin-top:.35rem; font-size:.85rem; }
                </style>

                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" onclick="showPaymentTab('processors')">üè¶ Procesadores</div>
                    <div class="tab" onclick="showPaymentTab('stripe')">üí≥ Stripe</div>
                </div>

                <!-- Processors overview -->
                <div id="processors-tab" class="tab-content active">
                    <div id="processors-list"><div class="loading">Cargando procesadores...</div></div>
                    <div style="margin-top: .75rem;">
                        <button class="btn" onclick="loadProcessors()">üîÑ Actualizar</button>
                    </div>
                </div>

                <!-- Stripe config tab content -->
                <div id="stripe-tab" class="tab-content">
                    <div id="stripe-content"></div>
                </div>
            </div>
        </div>

        <!-- System Section -->
        <div id="system-section" class="section hidden">
            <div class="section-header">
                <div class="section-title">üîß Administraci√≥n del Sistema</div>
            </div>
            <div class="section-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="system-uptime">-</div>
                        <div class="stat-label">Uptime</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="db-size">-</div>
                        <div class="stat-label">DB Size</div>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <button class="btn btn-warning" onclick="createBackup()">üì¶ Crear Backup</button>
                    <button class="btn btn-danger" onclick="downloadLogs()">üìÑ Descargar Logs</button>
                </div>

                <div id="system-logs" style="margin-top: 2rem;">
                    <h3>üìÑ Logs del Sistema</h3>
                    <div class="loading">Cargando logs...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = localStorage.getItem('authToken');
        let currentUser = localStorage.getItem('username');
        
        // Simple API helper with auth header
        async function apiCall(path, method = 'GET', data) {
            const opts = { method, headers: { 'Content-Type': 'application/json' } };
            if (authToken) opts.headers['Authorization'] = `Bearer ${authToken}`;
            if (data) opts.body = JSON.stringify(data);
            const res = await fetch(path, opts);
            if (res.status === 401 || res.status === 403) {
                try { localStorage.removeItem('authToken'); } catch (_) {}
                // Redirect to login preserving target
                const next = encodeURIComponent(window.location.pathname.replace(/^\/+/, '') + window.location.search);
                window.location.href = `/login.html?next=${next}&reason=expired`;
                throw new Error(`${method} ${path} -> HTTP ${res.status} (auth)`);
            }
            if (!res.ok) throw new Error(`${method} ${path} -> HTTP ${res.status}`);
            return res.json();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!authToken) {
                window.location.href = '/login.html';
                return;
            }
            
            document.getElementById('username').textContent = currentUser || 'Admin';
            loadDashboard();
        });

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Remove active class from nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').classList.remove('hidden');
            
            // Add active class to clicked nav item
            event.target.classList.add('active');
            
            // Load section data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'events':
                    loadEvents();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'downloads':
                    loadDownloads();
                    break;
                case 'payments':
                    // Default to processors tab
                    // Reset tabs state
                    document.querySelectorAll('#payments-section .tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('#payments-section .tab[onclick*="processors"]').classList.add('active');
                    document.querySelectorAll('#payments-section .tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById('processors-tab').classList.add('active');
                    loadProcessors();
                    break;
                case 'system':
                    loadSystemInfo();
                    break;
            }
        }

        // Payment tabs controller
        function showPaymentTab(tabId) {
            // tabs
            document.querySelectorAll('#payments-section .tab').forEach(t => t.classList.remove('active'));
            // contents
            document.querySelectorAll('#payments-section .tab-content').forEach(c => c.classList.remove('active'));
            // activate
            if (event && event.target) { event.target.classList.add('active'); }
            const content = document.getElementById(`${tabId}-tab`);
            if (content) content.classList.add('active');

            // load specific content
            if (tabId === 'processors') {
                loadProcessors();
            } else if (tabId === 'stripe') {
                loadStripeConfig();
            }
        }

        // Mask helper
        function maskValue(val, start = 3, end = 4) {
            if (!val) return '-';
            try {
                const s = String(val);
                if (s.length <= start + end) return s[0] + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                return s.slice(0, start) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + s.slice(-end);
            } catch (_) { return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; }
        }

        // Load processors overview
    async function loadProcessors() {
            try {
                const resp = await apiCall('/api/payment/processors');
        const processorsRaw = resp && Array.isArray(resp.processors) ? resp.processors : (Array.isArray(resp) ? resp : []);
        const processors = processorsRaw.filter(p => (p.name || '').toLowerCase() === 'stripe');
                const container = document.getElementById('processors-list');
                if (!processors || !Array.isArray(processors) || processors.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No hay procesadores configurados</div>';
                    return;
                }
                container.innerHTML = processors.map(p => `
                    <div class="proc-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div style="font-weight:700;">${p.display_name || 'üí≥ Stripe'}</div>
                            <span class="badge ${p.active ? 'badge-success' : 'badge-danger'}">${p.active ? 'Activo' : 'Inactivo'}</span>
                        </div>
                        <div style="margin-top:.25rem;color:#4a5568;">
                            Entorno: <strong>${p.environment || '-'}</strong> ¬∑ Configurado: <strong>${p.is_configured ? 'S√≠' : 'No'}</strong>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading processors', e);
                document.getElementById('processors-list').innerHTML = '<div class="alert alert-error">Error cargando procesadores</div>';
            }
        }
        
        // Status icon helper (restored)
        function getStatusIcon(status) {
            switch(status) {
                case 'succeeded': return '‚úÖ';
                case 'failed': return '‚ùå';
                case 'canceled': return 'üö´';
                case 'requires_action': return '‚ö†Ô∏è';
                case 'creation_failed': return 'üí•';
                case 'requires_payment_method': return 'üí≥';
                case 'requires_confirmation': return 'üîÑ';
                case 'processing': return '‚è≥';
                default: return '‚ùì';
            }
    }

        // Helper function to get badge class
        function getBadgeClass(status) {
            switch(status) {
                case 'succeeded': return 'badge-success';
                case 'failed':
                case 'creation_failed': return 'badge-error';
                case 'canceled': return 'badge-warning';
                case 'requires_action':
                case 'requires_payment_method':
                case 'requires_confirmation':
                case 'processing': return 'badge-pending';
                default: return 'badge-info';
            }
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                const stats = await apiCall('/api/dashboard/stats');
                if (stats) {
                    document.getElementById('total-users').textContent = stats.totalUsers || '0';
                    document.getElementById('total-events').textContent = stats.totalEvents || '0';
                    document.getElementById('total-transactions').textContent = stats.totalTransactions || '0';
                    document.getElementById('total-revenue').textContent = stats.totalRevenue || '0';
                    
                    // Nuevas estad√≠sticas
                    document.getElementById('successful-transactions').textContent = stats.successfulTransactions || '0';
                    document.getElementById('failed-transactions').textContent = stats.failedTransactions || '0';
                    document.getElementById('canceled-transactions').textContent = stats.canceledTransactions || '0';
                    document.getElementById('pending-transactions').textContent = stats.pendingTransactions || '0';
                    document.getElementById('success-rate').textContent = stats.successRate || '0%';
                }

                const transactions = await apiCall('/api/dashboard/transactions');
                if (transactions) {
                    const activityHtml = transactions.slice(0, 5).map(t => {
                        const statusIcon = getStatusIcon(t.status);
                        const errorInfo = t.metadata && (t.metadata.failure_message || t.metadata.error_message) 
                            ? `<br><small style="color: #e53e3e;">üîç ${t.metadata.failure_message || t.metadata.error_message}</small>` 
                            : '';
                        
                        return `
                            <div style="padding: 1rem; border-bottom: 1px solid #eee;">
                                <strong>$${t.amount_display}</strong> ${statusIcon} ${t.status_display || t.status}
                                ${t.username ? `<br><small>üë§ ${t.username}</small>` : ''}
                                ${errorInfo}
                                <br><small>üïí ${new Date(t.created_at).toLocaleString()}</small>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('recent-activity').innerHTML = 
                        activityHtml || '<div class="alert alert-info">No hay actividad reciente</div>';
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('recent-activity').innerHTML = 
                    '<div class="alert alert-error">Error cargando datos</div>';
            }
        }

        function refreshDashboard() {
            loadDashboard();
        }

        // Users functions
        async function loadUsers() {
            try {
                document.getElementById('users-content').innerHTML = '<div class="loading">Cargando usuarios...</div>';
                
                const users = await apiCall('/api/dashboard/users');
                if (users && users.length > 0) {
                    const tableHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Usuario</th>
                                        <th>Fecha Creaci√≥n</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${users.map(user => `
                                        <tr>
                                            <td>${user.id}</td>
                                            <td><strong>${user.username}</strong></td>
                                            <td>${new Date(user.created_at).toLocaleString()}</td>
                                            <td>
                                                <button class="btn btn-warning" onclick="editUser(${user.id})">‚úèÔ∏è Editar</button>
                                                <button class="btn btn-danger" onclick="deleteUser(${user.id})">üóëÔ∏è Eliminar</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    document.getElementById('users-content').innerHTML = tableHtml;
                } else {
                    document.getElementById('users-content').innerHTML = 
                        '<div class="alert alert-info">No hay usuarios registrados</div>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-content').innerHTML = 
                    '<div class="alert alert-error">Error cargando usuarios</div>';
            }
        }

        // Events functions
        async function loadEvents() {
            try {
                document.getElementById('events-content').innerHTML = '<div class="loading">Cargando eventos...</div>';
                
                const events = await apiCall('/api/dashboard/events');
                if (events && events.length > 0) {
                    const tableHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>C√≥digo</th>
                                        <th>Nombre</th>
                                        <th>Descripci√≥n</th>
                                        <th>Creado por</th>
                                        <th>Estado</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${events.map(event => `
                                        <tr>
                                            <td>${event.id}</td>
                                            <td><strong>${event.code}</strong></td>
                                            <td>${event.name}</td>
                                            <td>${event.description || '-'}</td>
                                            <td>${event.creator_name || 'Desconocido'}</td>
                                            <td>
                                                <span class="badge ${event.active ? 'badge-success' : 'badge-danger'}">
                                                    ${event.active ? 'Activo' : 'Inactivo'}
                                                </span>
                                            </td>
                                            <td>${new Date(event.created_at).toLocaleString()}</td>
                                            <td>
                                                <button class="btn btn-warning" onclick="editEvent(${event.id})">‚úèÔ∏è Editar</button>
                                                <button class="btn ${event.active ? 'btn-danger' : 'btn-success'}" 
                                                        onclick="toggleEvent(${event.id}, ${event.active})">
                                                    ${event.active ? '‚ùå Desactivar' : '‚úÖ Activar'}
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    document.getElementById('events-content').innerHTML = tableHtml;
                } else {
                    document.getElementById('events-content').innerHTML = 
                        '<div class="alert alert-info">No hay eventos registrados</div>';
                }
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('events-content').innerHTML = 
                    '<div class="alert alert-error">Error cargando eventos</div>';
            }
        }

        // Transactions functions
        async function loadTransactions() {
            try {
                document.getElementById('transactions-content').innerHTML = '<div class="loading">Cargando transacciones...</div>';
                
                const transactions = await apiCall('/api/dashboard/transactions');
                if (transactions && transactions.length > 0) {
                    const tableHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Usuario</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                        <th>Detalles</th>
                                        <th>Fecha</th>
                                        <th>C√≥digo Evento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${transactions.map(t => {
                                        const statusIcon = getStatusIcon(t.status);
                                        const statusDisplay = t.status_display || t.status;
                                        const badgeClass = getBadgeClass(t.status);
                                        
                                        let details = '';
                                        if (t.card_last4) {
                                            details += `üí≥ ****${t.card_last4}`;
                                            if (t.card_brand) details += ` (${t.card_brand})`;
                                        }
                                        
                                        if (t.metadata && (t.metadata.failure_message || t.metadata.error_message)) {
                                            const errorMsg = t.metadata.failure_message || t.metadata.error_message;
                                            details += `<br><small style="color: #e53e3e;">‚ùå ${errorMsg}</small>`;
                                        }
                                        
                                        if (t.metadata && t.metadata.decline_code) {
                                            details += `<br><small style="color: #ed8936;">üö´ ${t.metadata.decline_code}</small>`;
                                        }
                                        
                                        return `
                                            <tr>
                                                <td><small>${t.transaction_id}</small></td>
                                                <td>${t.username || 'N/A'}</td>
                                                <td><strong>$${t.amount_display}</strong></td>
                                                <td>${statusIcon} <span class="badge ${badgeClass}">${statusDisplay}</span></td>
                                                <td>${details || '-'}</td>
                                                <td><small>${new Date(t.created_at).toLocaleString()}</small></td>
                                                <td>${t.event_code || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    document.getElementById('transactions-content').innerHTML = tableHtml;
                } else {
                    document.getElementById('transactions-content').innerHTML = 
                        '<div class="alert alert-info">No hay transacciones registradas</div>';
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('transactions-content').innerHTML = 
                    '<div class="alert alert-error">Error cargando transacciones</div>';
            }
        }

        function refreshTransactions() {
            loadTransactions();
        }

        // Stripe functions
        async function loadStripeConfig() {
            try {
                document.getElementById('stripe-content').innerHTML = '<div class="loading">Cargando configuraci√≥n...</div>';
                
                const config = await apiCall('/api/stripe/config');
                
                const formHtml = `
                    <div id="stripe-form">
                        <div class="form-group">
                            <label class="form-label">üîë Publishable Key (pk_...)</label>
                            <input type="text" class="form-input" id="publishable_key" 
                                   value="${config ? config.publishable_key : ''}"
                                   placeholder="pk_test_... o pk_live_...">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üîê Secret Key (sk_...)</label>
                            <input type="password" class="form-input" id="secret_key" 
                                   value=""
                                   placeholder="sk_test_... o sk_live_...">
                            ${config ? '<small style="color: #666;">Clave actual: ' + config.secret_key + '</small>' : ''}
                        </div>

                        <div class="form-group">
                            <label class="form-label">üìç Terminal Location ID</label>
                            <input type="text" class="form-input" id="terminal_location_id" 
                                   value="" placeholder="tml_... (opcional, Tap to Pay)">
                            <small class="field-hint">Recomendado para Tap to Pay. Tambi√©n puedes configurarlo v√≠a variable STRIPE_TERMINAL_LOCATION_ID.</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="test_mode" ${config && config.test_mode ? 'checked' : ''}>
                                üß™ Modo de Prueba (Test Mode)
                            </label>
                            <small style="display: block; color: #666; margin-top: 0.5rem;">
                                Usa las claves de test para pruebas sin cargos reales
                            </small>
                        </div>
                        
                        ${config ? `
                            <div class="alert alert-info">
                                <strong>üìä Configuraci√≥n Actual:</strong><br>
                                ‚Ä¢ Publicable Key: ${config.publishable_key}<br>
                                ‚Ä¢ Secret Key: ${config.secret_key}<br>
                                ‚Ä¢ Modo: ${config.test_mode ? 'üß™ Prueba' : 'üöÄ Producci√≥n'}<br>
                                ‚Ä¢ Estado: ${config.active ? '‚úÖ Activa' : '‚ùå Inactiva'}<br>
                                ‚Ä¢ Creada: ${new Date(config.created_at).toLocaleString()}
                            </div>
                        ` : `
                            <div class="alert alert-warning">
                                <strong>‚ö†Ô∏è Sin Configuraci√≥n</strong><br>
                                No hay configuraci√≥n de Stripe activa. Configura las claves para habilitar pagos.
                            </div>
                        `}
                        
                        <div style="margin-top: 2rem;">
                            <button class="btn btn-success" onclick="saveStripeConfig()">
                                üíæ Guardar Configuraci√≥n
                            </button>
                            <button class="btn btn-warning" onclick="testStripeConnection()">
                                üî¨ Probar Conexi√≥n
                            </button>
                            <button class="btn" onclick="saveTerminalLocation()">üíæ Guardar Location ID</button>
                        </div>
                        
                        <div id="stripe-result" style="margin-top: 1rem;"></div>
                    </div>
                    
                    <!-- Webhooks Configuration Section -->
                    <div style="margin-top: 3rem; padding: 1.5rem; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h3>üîó Configuraci√≥n de Webhooks</h3>
                        <p>Los webhooks permiten que Stripe notifique autom√°ticamente a tu sistema sobre eventos de pago.</p>
                        
                        <div class="alert alert-info">
                            <strong>üìç URL del Webhook:</strong><br>
                            <code>https://api.be.terminal.beticket.net/webhooks/stripe</code>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üîê Webhook Secret (whsec_...)</label>
                            <input type="password" class="form-input" id="webhook_secret" 
                                   placeholder="whsec_... (opcional pero recomendado)">
                            <small style="color: #666;">
                                Secret para verificar que los webhooks vienen de Stripe. Se obtiene del dashboard de Stripe.
                            </small>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="saveWebhookSecret()">
                                üíæ Guardar Webhook Secret
                            </button>
                            <button class="btn btn-info" onclick="testWebhook()">
                                üß™ Probar Webhook
                            </button>
                        </div>
                        
                        <div id="webhook-result" style="margin-top: 1rem;"></div>
                    </div>
                    
                    <div style="margin-top: 3rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
                        <h3>üìñ Instrucciones para Configurar Webhooks</h3>
                        <ol>
                            <li><strong>Ve al dashboard de Stripe:</strong> <a href="https://dashboard.stripe.com/webhooks" target="_blank">https://dashboard.stripe.com/webhooks</a></li>
                            <li><strong>Clic en "Add endpoint"</strong></li>
                            <li><strong>URL del endpoint:</strong> <code>https://api.be.terminal.beticket.net/webhooks/stripe</code></li>
                            <li><strong>Eventos a escuchar:</strong>
                                <ul>
                                    <li><code>payment_intent.succeeded</code></li>
                                    <li><code>payment_intent.payment_failed</code></li>
                                </ul>
                            </li>
                            <li><strong>Copia el "Signing secret" (whsec_...)</strong> y p√©galo arriba</li>
                            <li><strong>Guarda la configuraci√≥n</strong></li>
                        </ol>
                        
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Importante:</strong> Los webhooks son esenciales para producci√≥n. Sin ellos, el sistema podr√≠a perder informaci√≥n sobre transacciones exitosas o fallidas.
                        </div>
                    </div>
                    
                    <div style="margin-top: 3rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
                        <h3>üìñ Instrucciones para Obtener las Claves de Stripe</h3>
                        <ol>
                            <li><strong>Accede a tu dashboard de Stripe:</strong> <a href="https://dashboard.stripe.com" target="_blank">https://dashboard.stripe.com</a></li>
                            <li><strong>Ve a "Developers" ‚Üí "API Keys"</strong></li>
                            <li><strong>Para pruebas:</strong> Usa las claves que empiecen con <code>pk_test_</code> y <code>sk_test_</code></li>
                            <li><strong>Para producci√≥n:</strong> Usa las claves que empiecen con <code>pk_live_</code> y <code>sk_live_</code></li>
                            <li><strong>Copia y pega las claves</strong> en los campos de arriba</li>
                            <li><strong>Marca "Modo de Prueba"</strong> si est√°s usando claves de test</li>
                        </ol>
                        
                        <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 4px;">
                            <strong>üîí Seguridad:</strong> Las claves secretas se almacenan de forma segura y solo se muestra una versi√≥n parcial.
                        </div>
                    </div>
                `;
                
                document.getElementById('stripe-content').innerHTML = formHtml;
                
            } catch (error) {
                console.error('Error loading Stripe config:', error);
                document.getElementById('stripe-content').innerHTML = 
                    '<div class="alert alert-error">Error cargando configuraci√≥n de Stripe</div>';
            }
        }

        async function saveStripeConfig() {
            try {
                const publishableKey = document.getElementById('publishable_key').value.trim();
                const secretKey = document.getElementById('secret_key').value.trim();
                const testMode = document.getElementById('test_mode').checked;
                
                if (!publishableKey || !secretKey) {
                    document.getElementById('stripe-result').innerHTML = 
                        '<div class="alert alert-error">Por favor completa ambas claves</div>';
                    return;
                }
                
                if (!publishableKey.startsWith('pk_')) {
                    document.getElementById('stripe-result').innerHTML = 
                        '<div class="alert alert-error">La clave publicable debe empezar con pk_</div>';
                    return;
                }
                
                if (!secretKey.startsWith('sk_')) {
                    document.getElementById('stripe-result').innerHTML = 
                        '<div class="alert alert-error">La clave secreta debe empezar con sk_</div>';
                    return;
                }
                
                const response = await apiCall('/api/stripe/config', 'POST', {
                    publishable_key: publishableKey,
                    secret_key: secretKey,
                    test_mode: testMode
                });
                
                if (response && response.success) {
                    document.getElementById('stripe-result').innerHTML = 
                        '<div class="alert alert-success">‚úÖ Configuraci√≥n guardada exitosamente</div>';
                    
                    // Reload the configuration
                    setTimeout(() => loadStripeConfig(), 1500);
                } else {
                    document.getElementById('stripe-result').innerHTML = 
                        '<div class="alert alert-error">‚ùå Error guardando configuraci√≥n: ' + (response.error || 'Error desconocido') + '</div>';
                }
                
            } catch (error) {
                console.error('Error saving Stripe config:', error);
                document.getElementById('stripe-result').innerHTML = 
                    '<div class="alert alert-error">‚ùå Error de conexi√≥n</div>';
            }
        }

        async function saveTerminalLocation() {
            try {
                const loc = (document.getElementById('terminal_location_id').value || '').trim();
                if (!loc) { alert('Ingresa un Location ID (tml_...)'); return; }
                const resp = await apiCall('/api/admin/terminal-location', 'POST', { location_id: loc });
                if (resp && resp.success) {
                    alert('‚úÖ Location ID guardado. Reinicia la app para aplicar.');
                } else {
                    alert('‚ùå No se pudo guardar el Location ID');
                }
            } catch (e) {
                alert('‚ùå Error guardando Location ID');
            }
        }

        async function testStripeConnection() {
            document.getElementById('stripe-result').innerHTML = 
                '<div class="alert alert-info">üî¨ Probando conexi√≥n con Stripe...</div>';
                
            // Simulate test - in a real implementation, you would test the API
            setTimeout(() => {
                document.getElementById('stripe-result').innerHTML = 
                    '<div class="alert alert-info">üî¨ Funci√≥n de prueba en desarrollo. Guarda la configuraci√≥n para activar Stripe.</div>';
            }, 1000);
        }

        async function saveWebhookSecret() {
            try {
                const webhookSecret = document.getElementById('webhook_secret').value.trim();
                
                if (webhookSecret && !webhookSecret.startsWith('whsec_')) {
                    document.getElementById('webhook-result').innerHTML = 
                        '<div class="alert alert-error">‚ùå El webhook secret debe empezar con whsec_</div>';
                    return;
                }
                
                const response = await apiCall('/api/stripe/webhook', 'POST', {
                    webhook_secret: webhookSecret
                });
                
                if (response && response.success) {
                    document.getElementById('webhook-result').innerHTML = 
                        '<div class="alert alert-success">‚úÖ Webhook secret guardado exitosamente</div>';
                } else {
                    document.getElementById('webhook-result').innerHTML = 
                        '<div class="alert alert-error">‚ùå Error guardando webhook secret: ' + (response.error || 'Error desconocido') + '</div>';
                }
                
            } catch (error) {
                console.error('Error saving webhook secret:', error);
                document.getElementById('webhook-result').innerHTML = 
                    '<div class="alert alert-error">‚ùå Error de conexi√≥n</div>';
            }
        }

        async function testWebhook() {
            try {
                document.getElementById('webhook-result').innerHTML = 
                    '<div class="alert alert-info">üß™ Probando webhook...</div>';
                
                const response = await apiCall('/api/stripe/webhook/test', 'POST');
                
                if (response && response.success) {
                    document.getElementById('webhook-result').innerHTML = 
                        '<div class="alert alert-success">‚úÖ Webhook funcionando correctamente</div>';
                } else {
                    document.getElementById('webhook-result').innerHTML = 
                        '<div class="alert alert-warning">‚ö†Ô∏è ' + (response.message || 'Webhook configurado pero no se pudo probar') + '</div>';
                }
                
            } catch (error) {
                console.error('Error testing webhook:', error);
                document.getElementById('webhook-result').innerHTML = 
                    '<div class="alert alert-error">‚ùå Error probando webhook</div>';
            }
        }

        // System functions
        async function loadSystemInfo() {
            try {
                const health = await apiCall('/api/health');
                if (health) {
                    document.getElementById('system-uptime').textContent = 'Online';
                    document.getElementById('db-size').textContent = 'OK';
                }
            } catch (error) {
                console.error('Error loading system info:', error);
            }
        }

        async function loadDownloads() {
            const container = document.getElementById('downloads-dynamic');
            container.innerHTML = '<div class="loading">Cargando descargas...</div>';
            try {
                const data = await apiCall('/api/admin/downloads');
                container.innerHTML = '';
                if (!data || !data.success) { 
                    container.innerHTML = '<div class="alert alert-error">No se pudo cargar la lista de descargas</div>'; 
                    return; 
                }
                const files = data.files || [];
                if (!files.length) { 
                    container.innerHTML = '<div class="alert alert-warning">No hay APKs disponibles</div>'; 
                    return; 
                }
                console.log('[downloads] archivos recibidos:', files.length);
                for (const f of files) {
                    const sizeMB = (f.size/1024/1024).toFixed(2);
                    const date = new Date(f.mtime).toLocaleString();
                    const isLatest = files[0] === f;
                    const versionLabel = f.version ? `Versi√≥n ${f.version}` : 'Sin versi√≥n detectada';
                    const card = document.createElement('div');
                    card.className = 'download-card';
                    card.innerHTML = `
                        <div class="download-icon">${isLatest ? 'üîê' : 'üì¶'}</div>
                        <div class="download-info">
                            <h3>${isLatest ? 'Release (Latest)' : f.name}</h3>
                            <p>${isLatest ? '√öltimo release Tap to Pay' : 'APK hist√≥rico'} ¬∑ ${versionLabel}</p>
                            <small>${date} ¬∑ ${sizeMB} MB${f.sha256 ? ' ¬∑ SHA256: <code>'+f.sha256.substring(0,12)+'...</code>' : ''}</small>
                        </div>
                        <div class="download-actions">
                            <a href="/downloads/${f.name}" class="btn ${isLatest ? 'btn-success' : 'btn-primary'}" download>‚¨áÔ∏è Descargar</a>
                        </div>`;
                    container.appendChild(card);
                }
            } catch (e) {
                console.error('Error loading downloads', e);
                const msg = e && e.message ? e.message : 'Error desconocido';
                container.innerHTML = `<div class="alert alert-error">Error cargando descargas (${msg}). ${msg.includes('401') || msg.includes('403') ? 'Reinicia sesi√≥n.' : 'Intenta de nuevo.'}</div>`;
            }
        }

        function refreshDownloads() { loadDownloads(); }

        async function createBackup() {
            try {
                const result = await apiCall('/api/admin/backup', 'POST');
                if (result && result.success) {
                    alert('‚úÖ Backup creado exitosamente');
                } else {
                    alert('‚ùå Error creando backup');
                }
            } catch (error) {
                console.error('Error creating backup:', error);
                alert('‚ùå Error creando backup');
            }
        }

        function downloadLogs() {
            alert('üìÑ Funci√≥n de descarga de logs en desarrollo');
        }

        // Auth functions
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
